<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>组织机构</title>
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="format-detection" content="telephone=no">
	<link rel="stylesheet" href="../../layui/css/layui.css" media="all" />
	<style>
		html,body{
			width: 100%;
			height: 100%;
		}
		body .layui-tree-skin-shihuang .layui-tree-branch{color: #EDCA50;}    
		.childrenBody{
			width: 100%;
			height: 100%;
			padding: 15px 0;
		}
		.addPeople,#chooseAuthority,#addDepartment{
			padding: 15px 0;
		} 
		
		.addPeople .layui-input-block,.editPeople .layui-input-block{
			margin-right: 20px;
		}
		#chooseAuthority .layui-input-block,.editPeople .layui-input-block{
			margin-right: 20px;
		}
		#addDepartment .layui-input-block,.editPeople .layui-input-block{
			margin-right: 20px;
		}
		.peopleTable{
			margin-left:-25px;
		}
		.red{
			color: red;
		}
		.uploadExcelTitle{
			line-height:50px;
			font-weight: 600;
		}
		#uploadExcel{
			padding: 20px;
		}
		#chooseFile{
		
			height: 30px;
			background: #6866E9;
			opacity: 0.7;
			line-height: 30px;
			border-radius: 15px ;
			font-size: 14px;
			text-align: center;
		}
		#chooseFile:hover{
			opacity: 1;
		}
		#uploadBtn{
	
			height: 30px;
			background: #46CE4E;
			opacity: 0.7;
			line-height: 30px;
			border-radius: 15px ;
			font-size: 14px;
			text-align: center;
			margin-left: 10px;
		}
		#uploadBtn:hover{
			opacity: 1;
		}
		.startUpload{
			margin-top: 10px;
		}
		.startUpload a:-webkit-any-link {
	    color: -webkit-link;
	    cursor: auto;
	    text-decoration: underline;
		}
		.organizationTitle{
			height: 40px;
			line-height: 40px;
			background: #e2e1eb;
			margin-top: 20px;
			padding-left: 10px;
			font-size: 14px;
			font-weight: 600;
		}
		.red{
			color: red;
		}
		
		/*导入文件*/
		.uploadExcelTitle{
			line-height:50px;
			font-weight: 600;
		}
		#uploadExcel_Organization,#uploadExcel_department{
			padding: 20px;
		}
		#chooseFileOrg,#chooseFileDpt{
			height: 30px;
			background: #6866E9;
			opacity: 0.7;
			line-height: 30px;
			border-radius: 15px ;
			font-size: 14px;
			text-align: center;
		}
		#chooseFileOrg:hover{
			opacity: 1;
		}
		#chooseFileDpt:hover{
			opacity: 1;
		}
		#uploadBtnOrg,#uploadBtnDpt{
			height: 30px;
			background: #46CE4E;
			opacity: 0.7;
			line-height: 30px;
			border-radius: 15px ;
			font-size: 14px;
			text-align: center;
			margin-left: 10px;
		}
		#uploadBtnOrg:hover{
			opacity: 1;
		}
		#uploadBtnDpt:hover{
			opacity: 1;
		}
		.startUpload{
			margin-top: 10px;
		}
		.startUpload a:-webkit-any-link {
		    color: -webkit-link;
		    cursor: auto;
		    text-decoration: underline;
		}
		
		#addOrganization {
			padding: 15px 0;
		} 
		
		#addOrganization .layui-input-block{
			margin-right: 20px;
		}
		#btns{
			height: 30px;
			background: #6866E9;
			opacity: 0.7;
			line-height: 30px;
			border-radius: 15px ;
			font-size: 14px;
			text-align: center;
		}
		#btns:hover{
			opacity: 1;
		}
		#btns1{
			height: 30px;
			background: #6866E9;
			line-height: 30px;
			border-radius: 15px ;
			font-size: 14px;
			text-align: center;
			opacity: 1;
		}
	
		#delBtn{
			height: 30px;
			opacity: 0.7;
			line-height: 30px;
			border-radius: 15px ;
			font-size: 14px;
			text-align: center;
		}
		#delBtn:hover{
			opacity: 1;
		}
		.newBox{
			display: inline-block;
			margin-right: 10px;
			position: relative;
		}
		.newBtns{
			display: none;
			position:absolute;
			left: 0;
			top:30px;
		}
		.red{
			color:red;
		}
		.layui-nav{
			background-color: #FFFFFF;
			padding: 0;
		}
	</style>
</head>
<body class="childrenBody">
	<div class="layui-fluid">
		<div class="layui-row organizationBox">
	     	<div class="layui-row">
		    	<div class="layui-row layui-col-md4">
		    		<ul class="layui-nav">
		    	<!--<div class="newBox">
		    		<button class="layui-btn toadd"  id="btns" style="width: 85px;">新增</button>
		    		<div class="newBtns">
		    			<button class="layui-btn" data-method="offset" data-type="auto" id="btns1" style="margin-left: 0;margin-top: 10px;">新增机构</button>
		    			<button class="layui-btn" data-method="offset2" data-type="auto" id="btns1" style="margin-left: 0;margin-top: 10px;">新增部门</button>
		    		</div>
		    	</div>-->
		     	
		     	  <li class="layui-nav-item">
				   <button class="layui-btn toadd"  id="btns" style="width: 85px;">新增</button>
				    <dl class="layui-nav-child">
				      <dd><a href="javascript:;" data-method="offset" data-type="auto" class="layui-btne">新增机构</a></dd>
				      <dd><a href="javascript:;" data-method="offset2" data-type="auto" class="layui-btne">新增部门</a></dd>
				    </dl>
				  </li>

		     	 <button class="layui-btn " data-method="offset_uploadExcel_organization" id="btns" style="margin-left: 10px;">导入机构</button>
		     	 <button class="layui-btn " data-method="offset_uploadExcel_department" id="btns">导入部门</button>
		     	</ul>
		    	</div>
		     	<div class="layui-row layui-col-md2  layui-col-md-offset6">
		     		<ul class="layui-nav">
		     			 <li style="margin-top: 15px;">
			     			 <button class="layui-btn layui-btn-primary" id="delBtn" data-method="offset_edit" >修改</button>
			     			 <button class="layui-btn layui-btn-primary" id="delBtn" data-method="offset_delete">删除</button>
		     		</li>
		     		</ul>
		     	</div>	
	     	</div>
	   	 	<div class="layui-row">
		    	<div class="layui-row organizationTitle">
		    		组织结构
		    	</div>
		    	<div class="layui-row rowTree">
		    		 <ul id="organizationTree"></ul>
		    	</div>
	     	</div>
	  </div>
  </div>
 </div>
   <div class="layui-row uploadExcel_Organization" id="uploadExcel_Organization" style="display: none;"> 
     	<p class="uploadExcelTitle">请选择要导入的组织机构数据文件(excle文件)</p>
     	<div class="layui-upload uploadExcelBtns">
		  <button type="button" class="layui-btn" id="chooseFileOrg">选择文件</button> 
		</div>
		<div class="startUpload">
			<a href="javaScript:;" url="http://wm-iot.oss-cn-shanghai.aliyuncs.com/ExcelOforg/model/model.xlsx" data-method="loadExcel" class="loadBtn">点击下载导入模版，填写后上传</a>
			<button type="button" class="layui-btn" id="uploadBtnOrg">开始上传</button>
		</div> 
    </div>
    <div class="layui-row uploadExcel_department" id="uploadExcel_department" style="display: none;"> 
     	<p class="uploadExcelTitle">请选择要导入的组织机构数据文件(excle文件)</p>
     	<div class="layui-upload uploadExcelBtns">
		  <button type="button" class="layui-btn" id="chooseFileDpt">选择文件</button> 
		</div>
		<div class="startUpload">
			<a href="javaScript:;" url="http://wm-iot.oss-cn-shanghai.aliyuncs.com/ExcelOfDepart/model/model.xlsx" data-method="loadExcel"  class="loadBtn">点击下载导入模版，填写后上传</a>
			<button type="button" class="layui-btn" id="uploadBtnDpt">开始上传</button>
		</div> 
    </div>
       <!--添加机构-->
    <div class="layui-row addOrganization" id="addOrganization" style="display: none;"> 
     		<form class="layui-form addOrganizationForm">
     			<div class="layui-form-item">
				    <label class="layui-form-label">机构编号<span class="red">*</span></label>
				    <div class="layui-input-block">
				      <input type="text" name="orgNo"  required  lay-verify="required"  placeholder="请输入机构编号" autocomplete="off" class="layui-input">
				    </div>
				</div>
				<div class="layui-form-item">
				    <label class="layui-form-label">机构名称<span class="red">*</span></label>
				    <div class="layui-input-block">
				      <input type="text" name="name" required  lay-verify="required" placeholder="请输入机构名称" autocomplete="off" class="layui-input">
				    </div>
				</div>
				<div class="layui-form-item">
				    <label class="layui-form-label">上级机构<span class="red">*</span></label>
				     <div class="layui-input-block">
				      <select name="parentId" lay-verify="required" class="organizationLast" lay-search lay-filter="organization">
				      	<option value=""></option>
				      </select>
				      <!--<input type="hidden" name="organizationTitle" id="organizationTitle" value="" />-->
				    </div>
				    <input type="hidden" name="id" id="id" value="" class="organizationId"/>
				    
				</div>
				<div class="layui-form-item" style="display: none;">
				    <div class="layui-input-block">
				      <button class="layui-btn submitadd" lay-submit lay-filter="formEdit">立即提交</button>
				      <input type="button"  value="取消" class="layui-btn layui-btn-primary cancleOpen">
				    </div>
				</div>
     	</form>
    </div>
	<!--添加部门-->
    <div class="layui-row addDepartment" id="addDepartment" style="display: none;"> 
     		<form class="layui-form addDepartmentForm">
     			<div class="layui-form-item">
				    <label class="layui-form-label">部门编号<span class="red">*</span></label>
				    <div class="layui-input-block">
				      <input type="text" name="departNo"  required  lay-verify="required"  placeholder="请输入部门编号" autocomplete="off" class="layui-input">
				    </div>
				</div>
				<div class="layui-form-item">
				    <label class="layui-form-label">部门名称<span class="red">*</span></label>
				    <div class="layui-input-block">
				      <input type="text" name="departName" required  lay-verify="required" placeholder="请输入部门名称" autocomplete="off" class="layui-input">
				    </div>
				</div>
				<div class="layui-form-item">
				    <label class="layui-form-label lableName">所属机构<span class="red">*</span></label>
				     <div class="layui-input-block">
				      <select name="organizationId" required  lay-verify="required" class="fromOrganization" lay-search lay-filter="depetSelect">
				      </select>
				    </div>
				     <input type="hidden" name="id" id="id" value="" class="departmentId"/>
				</div>
				<div class="layui-form-item" style="display: none;">
				    <div class="layui-input-block">
				      <button class="layui-btn submitDepartment" lay-submit lay-filter="departmentSub">立即提交</button>
				      <input type="button"  value="取消" class="layui-btn layui-btn-primary cancleOpen">
				    </div>
				</div>
	</form>
    </div>
    <!---->
	<script type="text/javascript" src="../../layui/layui.js"></script>
	<script type="text/javascript" src="../../js/peizhi.js"></script>
	<script type="text/javascript" src="../../jquery-1.10.1.min.js"></script>
	<script type="text/javascript" src="../../jquery.cookie.js"></script>
		<!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
<!--[if lt IE 9]>
  <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
  <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
	<script type="text/javascript">
		
	layui.use(['tree','layer','jquery','table','form','upload','element'], function(){
		//var apiUrl='http://192.168.1.246:9070/';
		var apiUrl=ApiUrl
		 var element = layui.element;	
		$ = layui.jquery;
		var table = layui.table,
		 layer = layui.layer,
		 upload = layui.upload,
		 form = layui.form;
		 var nodeId='';
		 var isOrg='';
		 var nodeObj={};
		function hasClass(elem, cls) {
		  cls = cls || '';
		  if (cls.replace(/\s/g, '').length == 0) return false; //当cls没有参数时，返回false
		  return new RegExp(' ' + cls + ' ').test(' ' + elem.className + ' ');
		}
		 
		function addClass(ele, cls) {
		  if (!hasClass(ele, cls)) {
		    ele.className = ele.className == '' ? cls : ele.className + ' ' + cls;
		  }
		}
		 
		function removeClass(elem, cls) {
		  if (hasClass(elem, cls)) {
		    var newClass = ' ' + elem.className.replace(/[\t\r\n]/g, '') + ' ';
		    while (newClass.indexOf(' ' + cls + ' ') >= 0) {
		      newClass = newClass.replace(' ' + cls + ' ', ' ');
		    }
		    elem.className = newClass.replace(/^\s+|\s+$/g, '');
		  }
		} 
	
		function upData(nurl,params,successFunc,type){
				$.ajax({
					type:type,
					url:apiUrl+nurl,
					data:params,
					contentType: "application/json",
					async:true,
					xhrFields:{
    			    withCredentials:true,
    		        },
                    crossDomain:true,
					success:successFunc
				});
			
		}
	function loadTree(){
		var dataArr=[];
	
	$.ajax({
				type:"get",
				url:apiUrl+"org/getOrgAndDeptInfo",
				data:{},
				async:false,
				xhrFields:{
    			withCredentials:true,
    		    },
                crossDomain:true,

				success:function(data){
					if(data.code==1){
					if(data.data.length){
						dataArr=data.data;
						/*for(var i=0;i<dataArr.length;i++){
							findChildren(dataArr[i])
						}*/
						dataArr=JSON.parse(dataArr);
						console.log(dataArr)
						isOrg=dataArr[0].isOrg;
						nodeObj=dataArr[0];
						$('#organizationTree').html('')
							layui.tree({
								  elem: '#organizationTree' //传入元素选择器
								  ,nodes:dataArr
								,click: function(node){
								    console.log(node) //node即为当前点击的节点数据
									var that=event.target;
								    if(that.tagName=='CITE'||that.tagName=='cite'){
								    	 	nodeId=node.id;
											isOrg=node.isOrg;
											nodeObj=node;
										    $('#organizationTree').find('cite').removeClass('red')
										   	$('#organizationTree').find('cite').css('color','#333333')
										   	addClass(that, "red")
										   	that.style.color='red'
								    }
								 } 
								,skin:'shihuang'
							});
					}else{
						$('#organizationTree').html('')
					}
					}
				}
			});
	}
	
	loadTree()	
function findChildren(arr){
		id=arr.id
			$.ajax({
				type:"get",
				url:apiUrl+"org/getOrgAndDeptInfo",
				data:{
					"parentId":id
				},
				async:false,
				xhrFields:{
    			    withCredentials:true,
    		        },
                    crossDomain:true,
				success:function(data){
					console.log(data)
					var DataArr=data.data;
					arr['children']=DataArr;	
					if(DataArr.length>0){
						for(c=0;c<DataArr.length;c++){
								findChildren(DataArr[c])	
							}
					}
				
			}
			});		
}
	var chooseStop="add";	
		 //触发事件
  var active = {
    offset: function(othis){
      var type = othis.data('type')
      ,text = othis.text();
      var openAdd=layer.open({
        type: 1
       	,title: '添加机构'
       	,area: ['570px', '460px']
        ,offset: type //具体配置参考：http://www.layui.com/doc/modules/layer.html#offset
        ,id: 'layerDemo'+type //防止重复弹出
        ,content: $("#addOrganization")
        ,btn: ['保存',"取消"]
        ,btnAlign: 'r' //按钮居中
        ,shade: 0.3 //不显示遮罩
        ,btn2: function(){
          layer.closeAll();
        }
        ,yes: function(){
        	chooseStop="add";
        	$('.submitadd').click();
        	return false
         //	layer.msg('保存成功', {icon: 6});
        }
        ,success:function(){
        	$('.organizationId').val(null)
        	$("#addOrganization").find('input').val('');
        	upData('org/getOrgInfoByCondition',{},successFunc,"post")//查所有机构列表
        	function successFunc(data){
        		if(data.length){
        			var orgStr='<option value=""></option><option value="0">无</option>';
        			for(var i=0;i<data.length;i++){
        				if(data[i].id==nodeId){
        					orgStr+='<option value="'+data[i].id+'" selected>'+data[i].name+'</option>';
        				}else{
        					orgStr+='<option value="'+data[i].id+'">'+data[i].name+'</option>';
        				}
        				
        			}
        		}else{
        			var orgStr='<option value="0">无</option>';
        		}
        		
        		$('.organizationLast').html(orgStr)
        		 form.render('select');
        	}
        	
        	 form.on('select(organization)', function(data){
			  console.log(data.elem); //得到select原始DOM对象
			  console.log(data.value); //得到被选中的值
			  console.log(data.othis); //得到美化后的DOM对象
			  $('.addOrganization input[name="organizationTitle"]').val(data.elem.options[data.elem.selectedIndex].text)
			  console.log(data.elem.options[data.elem.selectedIndex].text)
			}); 
        }
      });
    }
     ,offset2: function(othis){
      var type = othis.data('type')
      ,text = othis.text();
      var openAdd=layer.open({
        type: 1
       	,title: '添加部门'
       	,area: ['570px', '460px']
        ,offset: type //具体配置参考：http://www.layui.com/doc/modules/layer.html#offset
        ,id: 'layerDemo'+type //防止重复弹出
        ,content: $("#addDepartment")
        ,btn: ['保存',"取消"]
        ,btnAlign: 'r' //按钮居中
        ,shade: 0.3 //不显示遮罩
        ,btn2: function(){
          layer.closeAll();
        }
        ,yes: function(){
        	chooseStop="add";
        	$('.submitDepartment').click();
        	return false
         //	layer.msg('保存成功', {icon: 6});
        }
        ,success:function(){
        	
        	$("#addDepartment").find('input').val('');
        	$('.departmentId').val(null)//新增不需要传id
        	upData('org/getOrgInfoByCondition',{},successFunc,"post")
        	function successFunc(data){
        		var parentsOrangId;
        		var parentsOrangName;
        		if(data.length){
        			var orgStr='<option value=""></option>';
        			if(isOrg=="1"){
        				for(var i=0;i<data.length;i++){
        					if(data[i].id==nodeId){
        						orgStr+='<option value="'+data[i].id+'" selected>'+data[i].name+'</option>';
        					}else{
        						orgStr+='<option value="'+data[i].id+'">'+data[i].name+'</option>';
        					}
        					
        				}
        			}else if(isOrg=="0"){
        					var parentParams={"id":nodeId}
	        				$.ajax({
	        					type:"get",
	        					url:apiUrl+"depart/getOrgInfoByDepart",
	        					data:parentParams,
	        					async:false,
	        					xhrFields:{
    			   				 withCredentials:true,
    		        },
                    crossDomain:true,
	        					success:function(res){
	        						parentsOrangName=res.data.name;
	        						parentsOrangId=res.data.id;
	        					}
        				});
        					for(var i=0;i<data.length;i++){
	        					if(data[i].id==parentsOrangId){
	        						orgStr+='<option value="'+data[i].id+'" selected>'+data[i].name+'</option>';
	        					}else{
	        						orgStr+='<option value="'+data[i].id+'">'+data[i].name+'</option>';
	        					}
        					}
        			}else{//什么节点都没选的情况
        				for(var i=0;i<data.length;i++){
	        					orgStr+='<option value="'+data[i].id+'">'+data[i].name+'</option>';
        					}
        				
        			}
        			
        			
        		}else{
        			layer.msg("暂无可选上级机构，请先维护机构！")
        		}
        		$('.fromOrganization').html(orgStr)
        		
        		 form.render('select');
        	}
        	
        	 form.on('select(depetSelect)', function(data){
			  console.log(data.elem); //得到select原始DOM对象
			  console.log(data.value); //得到被选中的值
			  console.log(data.othis); //得到美化后的DOM对象
			 // $('.addOrganization input[name="organizationTitle"]').val(data.elem.options[data.elem.selectedIndex].text)
			  console.log(data.elem.options[data.elem.selectedIndex].text)
			}); 
        }
      });
    }
    ,offset_edit: function(othis){
      var type = othis.data('type')
      ,text = othis.text();
      if(nodeId!=''){
      if(isOrg=="1"){
      	 var openAdd=layer.open({
	        type: 1
	       	,title: '修改机构'
	       	,area: ['570px', '460px']
	        ,offset: type //具体配置参考：http://www.layui.com/doc/modules/layer.html#offset
	        ,id: 'layerDemo'+type //防止重复弹出
	        ,content: $("#addOrganization")
	        ,btn: ['保存',"取消"]
	        ,btnAlign: 'r' //按钮居中
	        ,shade: 0.3 //不显示遮罩
	        ,btn2: function(){
	          layer.closeAll();
	        }
	        ,yes: function(){
	        	chooseStop="edit";
	        	$('.submitadd').click();
	        	return false
	         //	layer.msg('保存成功', {icon: 6});
	        }
	        ,success:function(){
	        	$('.organizationId').val(nodeId)
	        	$('#addOrganization input[name="name"]').val(nodeObj.title)
	        	$('#addOrganization input[name="orgNo"]').val(nodeObj.code)
	        	
	        	upData('org/getOrgInfoByCondition',{},successFunc,"post")
        		function successFunc(data){
        		if(data.length){
        			var orgStr='<option value=""></option>';
        			if(nodeObj.parentId=='0'){
        				orgStr+='<option selected value="0">无</option>'
        			}else{
        				orgStr+='<option  value="0">无</option>'
        			}
        			for(var i=0;i<data.length;i++){
        				if(nodeObj.parentId==data[i].id){
        					orgStr+='<option value="'+data[i].id+'" selected>'+data[i].name+'</option>';
        				}else{
        					orgStr+='<option value="'+data[i].id+'">'+data[i].name+'</option>';
        				}
        			}
        		}
        		
        		$('.organizationLast').html(orgStr)
        		 form.render('select');
        	}
        	
        	 form.on('select(organization)', function(data){
			  console.log(data.elem); //得到select原始DOM对象
			  console.log(data.value); //得到被选中的值
			  console.log(data.othis); //得到美化后的DOM对象
			  $('.addOrganization input[name="organizationTitle"]').val(data.elem.options[data.elem.selectedIndex].text)
			}); 
	        	//$("#addDepartment").find('input').val('');
	        }
	      });
      }
      if(isOrg==""){
      	layer.open({
        type: 1
       	,title: '修改部门'
       	,area: ['570px', '460px']
        ,offset: type //具体配置参考：http://www.layui.com/doc/modules/layer.html#offset
        ,id: 'layerDemo'+type //防止重复弹出
        ,content: $("#addDepartment")
        ,btn: ['保存',"取消"]
        ,btnAlign: 'r' //按钮居中
        ,shade: 0.3 //不显示遮罩
        ,btn2: function(){
          layer.closeAll();
        }
        ,yes: function(){
        	chooseStop="edit";
        	$('.submitDepartment').click();
        	return false
         //	layer.msg('保存成功', {icon: 6});
        }
        ,success:function(){
        	//$("#addDepartment").find('input').val('');
        		$('.departmentId').val(nodeId)
	        	$('#addDepartment input[name="departName"]').val(nodeObj.title)
	        	$('#addDepartment input[name="departNo"]').val(nodeObj.code)
	        	
	        	upData('org/getOrgInfoByCondition',{},successFunc,"post")
        		function successFunc(data){
        		if(data.length){
        			var orgStr='<option value=""></option>';
        			for(var i=0;i<data.length;i++){
        				if(nodeObj.parentId==data[i].id){
        					orgStr+='<option value="'+data[i].id+'" selected>'+data[i].name+'</option>';
        				}else{
        					orgStr+='<option value="'+data[i].id+'">'+data[i].name+'</option>';
        				}
        			}
        		}
        		
        		$('.fromOrganization').html(orgStr)
        		 form.render('select');
        	}
        	
        	 form.on('select(depetSelect)', function(data){
			  console.log(data.elem); //得到select原始DOM对象
			  console.log(data.value); //得到被选中的值
			  console.log(data.othis); //得到美化后的DOM对象
			 // $('.addOrganization input[name="organizationTitle"]').val(data.elem.options[data.elem.selectedIndex].text)
			}); 
        }
      });
     
      }
    }else{
      	layer.msg('请先选择要修改的机构或部门！');
     }
    }
   	,offset_uploadExcel_organization: function(othis){
      var type = othis.data('type')
      ,text = othis.text();
      var openAdd=layer.open({
        type: 1
       	,title: '导入的组织机构-机构'
       	,area: ['370px', '260px']
        ,offset: type //具体配置参考：http://www.layui.com/doc/modules/layer.html#offset
        ,id: 'layerDemo'+type //防止重复弹出
        ,content: $("#uploadExcel_Organization")
        ,btn: ["取消"]
        ,btnAlign: 'r' //按钮居中
        ,shade: 0.3 //不显示遮罩
        ,yes: function(){
          layer.closeAll();
        }
      });
    } 
    ,offset_uploadExcel_department: function(othis){
      var type = othis.data('type')
      ,text = othis.text();
      var openAdd=layer.open({
        type: 1
       	,title: '导入的组织机构-部门'
       	,area: ['370px', '260px']
        ,offset: type //具体配置参考：http://www.layui.com/doc/modules/layer.html#offset
        ,id: 'layerDemo'+type //防止重复弹出
        ,content: $("#uploadExcel_department")
        ,btn: ["取消"]
        ,btnAlign: 'r' //按钮居中
        ,shade: 0.3 //不显示遮罩
        ,yes: function(){
          layer.closeAll();
        }
      });
    } 
    ,offset_delete: function(){
    	if(nodeId!=''){
    		layer.confirm('确定删除所选信息？', {icon: 3, title:'提示'}, function(index){
    			var params={"id":nodeId}
    			//params=JSON.stringify(params)
    			var deleteUrl=''
    			if(isOrg=="1"){
    				deleteUrl='org/deleteOrgInfo';
    			}else if(isOrg=="0"){
    				deleteUrl='depart/deleteDepartInfo';
    			}
    			
    		//删除函数	
		 	upData(deleteUrl,params,successFunc,"get")
        		function successFunc(data){
        			console.log(data)
        			if(data.code=="1"){
        				loadTree()	
        				layer.msg('删除成功!')
        			}else{
        					layer.msg(data.data)
        				}
        		}
		 	layer.close(index);
		});   
    	}else{
    		layer.msg('请先选要删除的部门或机构!')
    	}	
    }
    ,loadExcel:function(){
    	var src=$(this).attr('url');
	        if(browserIsIe()){//假如是ie浏览器  
	                DownLoadReportIMG(src);  
	        }else{  
	               NotIeDown(src,'模版')
	        }  
	    function DownLoadReportIMG(imgPathURL) {  
    //如果隐藏IFRAME不存在，则添加  
	    if (!document.getElementById("IframeReportImg"))  
	        $('<iframe style="display:none;" id="IframeReportImg" name="IframeReportImg" onload="DoSaveAsIMG();" width="0" height="0" src="about:blank"></iframe>').appendTo("body");  
	    if (document.all.IframeReportImg.src != imgPathURL) {  
	        //加载图片  
	        document.all.IframeReportImg.src = imgPathURL;  
	    }  
	    else {  
	        //图片直接另存为 
	        DoSaveAsIMG();  
	    }  
	}  
	function DoSaveAsIMG() {  
		if (document.all.IframeReportImg.src != "about:blank")  
		window.frames["IframeReportImg"].document.execCommand("SaveAs");  
	}  
	//判断是否为ie浏览器  
	function browserIsIe() {  
	    if (!!window.ActiveXObject || "ActiveXObject" in window)  
	        return true;  
	    else  
	        return false;  
	} 
	function NotIeDown(src,name){
	      var a = document.createElement("a");
	            a.href = src;
	            a.download =name;
	            a.click();
	} 
    }
  };
  
    //按钮
  $('.organizationBox .layui-btn,.organizationBox .layui-btne,.loadBtn').on('click', function(){
    var othis = $(this), method = othis.data('method');
    active[method] ? active[method].call(this, othis) : '';
  });
  
  
   form.on('submit(formEdit)', function(data){//组织机构新增与编辑
    //layer.msg(JSON.stringify(data.field));
   // layer.closeAll();
   if(chooseStop=="add"){
   	$.ajax({
   		type:"get",
   		url:apiUrl+"org/getCountByCode",
   		async:true,
   		xhrFields:{
    			withCredentials:true,
    		    },
                crossDomain:true,

   		data:{
   			orgCode:$('.addOrganizationForm').find('input[name="orgNo"]').val()
   		},
   		success:function(res){
   			//console.log(res)
   			if(res.status){
	   			$.ajax({
			    	type:"get",
			    	url:apiUrl+"org/insertOrgInfo",
			    	async:true,
			    	xhrFields:{
    			withCredentials:true,
    		    },
                crossDomain:true,
			    	data:$('.addOrganizationForm').serialize(),
			    	success:function(data){
			    		console.log(data)
			    		if(data.state=='0'){
			    			loadTree()
				    		layer.closeAll();
				    		layer.msg("新增成功");
			    		}else{
			    			layer.msg(data.msg);
			    		}
			    		
			    	}
			    });
   			}else{
   				layer.msg(res.data);
   			}
   		}
   	});
   		
    return false;
   }
 	  if(chooseStop=="edit"){
 	  	console.log($('.addOrganizationForm').serialize())
 	  	$.ajax({
   		type:"get",
   		url:apiUrl+"org/getCountByCode",
   		async:true,
   		xhrFields:{
    			withCredentials:true,
    		    },
                crossDomain:true,

   		data:{
   			orgCode:$('.addOrganizationForm').find('input[name="orgNo"]').val(),
   			id:nodeId
   		},
   		success:function(res){
   			if(res.status){
   			
	   		$.ajax({
	    	type:"get",
	    	url:apiUrl+"org/updateOrgInfo",
	    	async:true,
	    	xhrFields:{
    			    withCredentials:true,
    		        },
                    crossDomain:true,
	    	data:$('.addOrganizationForm').serialize(),
	    	success:function(data){
	    		console.log(data)
	    		if(data.state=='0'){
	    			loadTree()
		    		layer.closeAll();
		    		layer.msg("修改成功");
	    		}else{
	    			layer.msg(data.msg);
	    		}
	    		
	    	}
	    });
   	 }else{
   				layer.msg(res.data);
   			}
   		}
   	});
    return false;
   }
  });
  
   form.on('submit(departmentSub)', function(data){//部门新增与编辑
   // layer.closeAll();
   if(chooseStop=="add"){
   		$.ajax({
    	type:"get",
    	url:apiUrl+"depart/insertDepartInfo",
    	async:true,
    	xhrFields:{
    			withCredentials:true,
    		    },
                crossDomain:true,

    	data:$('.addDepartmentForm').serialize(),
    	success:function(data){
    		console.log(data)
    		if(data.state=='0'){
    			loadTree()
	    		layer.closeAll();
	    		layer.msg("新增成功");
    		}else{
    			layer.msg(data.msg);
    		}
    		
    	}
    });
    return false;
   }
 	  if(chooseStop=="edit"){
 	  	console.log($('.addDepartmentForm').serialize())
   		$.ajax({
    	type:"get",
    	url:apiUrl+"depart/updateDepartInfo",
    	async:true,
    	xhrFields:{
    			withCredentials:true,
    		    },
                crossDomain:true,

    	data:$('.addDepartmentForm').serialize(),
    	success:function(data){
    		console.log(data)
    		if(data.state=='0'){
    			loadTree()
	    		layer.closeAll();
	    		layer.msg("修改成功");
    		}else{
    			layer.msg(data.msg);
    		}
    		
    	}
    });
    return false;
   }
  });
    //上传
  //选完文件后不自动上传
  var groupCode = $.cookie('groupCode');
  upload.render({//上传机构
    elem: '#chooseFileOrg'
    ,url: apiUrl+'org/importExcelFile'
    ,auto: false
    ,data: {"groupCode":groupCode}
    //,multiple: true
    ,bindAction: '#uploadBtnOrg'
    ,exts:'xlsx|xls'
    ,done: function(res){
      console.log(res)
      if(res.code=='0'){
      	 layer.closeAll();
      	 loadTree()
      }
      layer.msg(res.msg)
    }
  });
   upload.render({//上传部门
    elem: '#chooseFileDpt'
    ,url: apiUrl+'depart/importExcelFile'
    ,auto: false
    ,data:{"groupCode":groupCode}
    //,multiple: true
    ,bindAction: '#uploadBtnDpt'
    ,exts:'xlsx|xls'
    ,done: function(res){
      console.log(res)
      if(res.code=='0'){
      	 layer.closeAll();
      	 loadTree()
      }
      layer.msg(res.msg)
    }
  });
  
  
  
 
});  
	</script>
</body>


    


</html>